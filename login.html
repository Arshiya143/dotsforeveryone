<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <link rel="stylesheet" href="styles/root.css" />
    <link rel="stylesheet" href="styles/custom.css" />
    <link rel="stylesheet" href="styles/cs.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
  </head>
  <body class="login">
    <div
      class="login-screen w-full h-screen flex items-center justify-center gap-2 relative cs"
    >
      <!-- main content -->
      <div class="left-background w-1/2 h-full bg-no-repeat bg-cover bg-center">
        <div class="blur-container"></div>
      </div>
      <div
        class="right-background w-1/2 h-full bg-no-repeat bg-cover bg-center"
      >
        <div class="login-container">
          <div
            class="user-login flex flex-col items-center justify-center w-full h-full gap-3"
          >
            <h1 class="text-2xl font-normal">Welcome To Dots !!!</h1>
            <button
              onclick="showModal(event)"
              class="transform transition duration-500 hover:scale-110"
            >
              <img class="h-32" src="/images/logo.png" alt="Logo" />
            </button>
          </div>
        </div>
      </div>

      <!-- voice and camera popup -->
      <div
        id="modal"
        role="dialog"
        class="fixed hidden inset-0 flex items-center justify-center bg-black bg-opacity-50 z-10"
      >
        <div
          class="bg-white rounded-2xl overflow-hidden shadow-lg max-w-md w-full bg-c-lighten-gray modal-content"
        >
          <!-- Sticky header -->
          <div
            class="sticky top-0 flex py-2 px-5 justify-between items-center border-b border-gray-3 bg-white z-10 text-c-black"
          >
            <div class="text-lg font-normal">Login</div>
            <button
              type="button"
              id="closeModalButton"
              class="py-1.5 rounded-md"
              onclick="event.stopPropagation();hideModal(event);"
            >
              <i class="ri-close-circle-fill text-black ri-lg"></i>
            </button>
          </div>
          <!-- Scrollable content -->
          <div class="overflow-y-auto max-h-full scroll bg-white">
            <div class="container-fluid">
              <div
                class="col-11 col-sm-10 col-md-10 col-lg-6 col-xl-5 text-center p-0 mt-3"
              >
                <div class="card">
                  <form id="msform">
                    <!-- First Step: Camera -->
                    <fieldset>
                      <div class="form-card space-y-3">
                        <div
                          id="camera-error"
                          class="flex gap-2 text-red-600 justify-center items-center hidden"
                        >
                          <i class="ri-error-warning-fill ri-xl"></i>
                          <p>Failed to capture photo</p>
                        </div>
                        <div
                          class="relative flex justify-center items-center mx-auto w-8/12"
                        >
                          <video
                            id="cam"
                            autoplay
                            muted
                            playsinline
                            class="rounded-lg"
                          >
                            Not available
                          </video>
                          <!-- Countdown Overlay -->
                          <div
                            id="countdown-overlay"
                            class="absolute w-full h-full flex items-center justify-center bg-black bg-opacity-50 hidden right-0 rounded-lg"
                          >
                            <span
                              id="countdown-text"
                              class="text-c-white text-4xl font-bold"
                            ></span>
                          </div>
                          <canvas id="canvas" class="hidden"></canvas>
                          <img
                            id="photo"
                            alt="The screen capture will appear in this box."
                            class="rounded-lg absolute right-0 hidden"
                          />
                        </div>
                      </div>
                      <input
                        id="retake"
                        type="button"
                        class="bg-c-black hover-bg-c-black text-c-white rounded-full w-3/12 py-2 text-sm cursor-pointer hidden mt-5 mr-3"
                        value="Retry"
                      />
                      <input
                        id="next-voice"
                        type="button"
                        name="next"
                        class="next bg-c-black hover-bg-c-black text-c-white rounded-full w-4/12 py-2 text-sm cursor-pointer mt-5 hidden"
                        value="Login with voice"
                      />
                    </fieldset>

                    <!-- Second Step: Voice -->
                    <fieldset>
                      <div class="form-card space-y-5">
                        <div
                          id="voice-error"
                          class="flex gap-2 text-red-600 justify-center items-center hidden"
                        >
                          <i class="ri-error-warning-fill ri-xl"></i>
                          <p>Failed to record voice</p>
                        </div>
                        <div
                          class="container flex flex-col justify-center items-center space-y-5"
                        >
                          <div class="mic-container relative">
                            <div
                              class="circle cursor-pointer has-tooltip"
                              id="start"
                            >
                              <i class="ri-mic-line mic"></i>
                            </div>
                            <div
                              id="voice-retake"
                              class="absolute border tooltip border-c-yellow z-20 top-0 left-12 bg-white px-3 py-1 text-xs rounded-md"
                            >
                              Record
                            </div>
                          </div>
                          <audio id="recorder" muted hidden></audio>
                          <audio id="player" controls></audio>
                        </div>
                      </div>
                      <input
                        id="next-login"
                        type="button"
                        name="next"
                        class="next bg-c-black hover-bg-c-black text-white rounded-full py-2 px-5 text-sm mt-5 cursor-pointer hidden"
                        value="Login with user credentials"
                      />
                    </fieldset>

                    <!-- Third Step: User Credentials -->
                    <fieldset>
                      <div class="form-card">
                        <div
                          class="right-container flex flex-col justify-center items-center gap-7"
                        >
                          <input
                            class="userinput"
                            type="text"
                            placeholder="Username"
                            required
                          />
                          <input
                            class="userinput"
                            type="password"
                            placeholder="Password"
                            required
                          />
                          <button
                            class="next userinput"
                            id="login-btn"
                            name="next"
                          >
                            Login
                          </button>
                        </div>
                      </div>
                    </fieldset>

                    <!-- Fourth Step: Confirmation -->
                    <fieldset>
                      <div
                        class="flex flex-col items-center justify-center gap-3"
                      >
                        <h1 class="text-c-green text-xl">Hi John</h1>
                        <img src="/images/profile.png" alt="Logo" />
                        <h1 class="text-c-green text-xl">
                          Welcome To Dots !!!
                        </h1>
                      </div>
                    </fieldset>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script defer>
      // showModal
      function showModal() {
        $("#modal").removeClass("hidden");
        $("#photo").addClass("hidden");
        switchCamera("user");
      }

      // hideModal
      function hideModal() {
        $("#modal").addClass("hidden");
      }

      /*** step form ***/
      let current_fs, next_fs, previous_fs; // Fieldsets
      let current = 1;
      const steps = $("fieldset").length;

      $(".next").click(function () {
        current_fs = $(this).closest("fieldset");
        next_fs = $(this).closest("fieldset").next();

        // Show the next fieldset
        next_fs.show();

        // Hide the current fieldset with style
        current_fs.animate(
          { opacity: 0 },
          {
            step: function (now) {
              const opacity = 1 - now;
              current_fs.css({
                display: "none",
                position: "relative",
              });
              next_fs.css({ opacity: opacity });
            },
            duration: 500,
          }
        );
      });

      /*** camera functionality ***/

      // Media Stream Handling
      let mediaStream = null;
      const constraints = {
        audio: false,
        video: {
          width: { ideal: 640 },
          height: { ideal: 480 },
          facingMode: "environment",
        },
      };

      // Lazy loading logic
      let observer = new IntersectionObserver(handleIntersection, {
        root: null,
        threshold: 0.1,
      });

      // Attach the observer to the camera element
      observer.observe(document.getElementById("cam"));

      // Intersection handler function
      function handleIntersection(entries, observer) {
        entries.forEach(async (entry) => {
          if (entry.isIntersecting) {
            await getMediaStream(constraints);
          } else {
            if (mediaStream && mediaStream.active) {
              const tracks = mediaStream.getVideoTracks();
              tracks.forEach((track) => track.stop());
            }
          }
        });
      }

      async function getMediaStream(constraints) {
        try {
          if (mediaStream && mediaStream.active) {
            const tracks = mediaStream.getVideoTracks();
            tracks.forEach((track) => track.stop());
          }
          mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
          $("#cam").prop("srcObject", mediaStream);
          $("#cam").on("loadedmetadata", function () {
            this.play();
          });
          startCountdown(); // Start the countdown when the modal is shown
        } catch (err) {
          console.error(err.message);
        }
      }

      // Function to start countdown
      function startCountdown() {
        let countdown = 5;
        $("#countdown-overlay").removeClass("hidden");
        $("#countdown-text").text(countdown);

        const countdownInterval = setInterval(() => {
          countdown--;
          $("#countdown-text").text(countdown);

          if (countdown === 0) {
            clearInterval(countdownInterval);
            $("#countdown-overlay").addClass("hidden");
            takePicture(); // Automatically take picture after countdown
            $("#retake").removeClass("hidden");
            $("#next-voice").removeClass("hidden");
            $("#camera-error").removeClass("hidden");
          }
        }, 1000);
      }

      async function switchCamera(cameraMode) {
        try {
          $("#cam").prop("srcObject", null);
          constraints.video.facingMode = cameraMode;

          await getMediaStream(constraints);
        } catch (err) {
          console.error(err.message);
          alert(err.message);
        }
      }

      function takePicture() {
        const context = $("#canvas")[0].getContext("2d");

        const height = $("#cam")[0].videoHeight;
        const width = $("#cam")[0].videoWidth;

        if (width && height) {
          $("#canvas").attr({ width, height });
          context.drawImage($("#cam")[0], 0, 0, width, height);
          const data = $("#canvas")[0].toDataURL("image/png");
          $("#photo").attr("src", data).removeClass("hidden");
        } else {
          clearPhoto();
        }
      }

      function clearPhoto() {
        const context = $("#canvas")[0].getContext("2d");
        context.fillStyle = "#AAA";
        context.fillRect(0, 0, $("#canvas").width(), $("#canvas").height());
        const data = $("#canvas")[0].toDataURL("image/png");
        $("#photo").attr("src", data);
      }

      $("#retake").click((event) => {
        event.preventDefault();
        $("#photo").addClass("hidden");
        switchCamera("user");
      });

      clearPhoto();

      /*** audio functionality ***/

      class VoiceRecorder {
        constructor() {
          if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            console.log("getUserMedia supported");
          } else {
            console.log("getUserMedia is not supported on your browser!");
          }

          this.mediaRecorder = null;
          this.stream = null;
          this.chunks = [];
          this.isRecording = false;

          this.recorderRef = $("#recorder")[0];
          this.playerRef = $("#player")[0];

          $("#start").click((event) => {
            event.preventDefault();
            if (this.isRecording) {
              this.stopRecording();
              $("#voice-error").removeClass("hidden");
              $("#next-login").removeClass("hidden");
            } else {
              this.startRecording();
            }
          });

          this.constraints = {
            audio: true,
            video: false,
          };
        }

        handleSuccess(stream) {
          this.stream = stream;
          this.stream.oninactive = () => {
            console.log("Stream ended!");
          };
          this.recorderRef.srcObject = this.stream;
          this.mediaRecorder = new MediaRecorder(this.stream);
          console.log(this.mediaRecorder);
          this.mediaRecorder.ondataavailable =
            this.onMediaRecorderDataAvailable.bind(this);
          this.mediaRecorder.onstop = this.onMediaRecorderStop.bind(this);
          this.recorderRef.play();
          this.mediaRecorder.start();
        }

        handleError(error) {
          console.log("navigator.getUserMedia error: ", error);
        }

        onMediaRecorderDataAvailable(e) {
          this.chunks.push(e.data);
        }

        onMediaRecorderStop() {
          const blob = new Blob(this.chunks, {
            type: "audio/ogg; codecs=opus",
          });
          const audioURL = window.URL.createObjectURL(blob);
          this.playerRef.src = audioURL;
          this.chunks = [];
          this.stream.getAudioTracks().forEach((track) => track.stop());
          this.stream = null;
        }

        startRecording() {
          const micContainer = $(".circle").first();
          if (this.isRecording) return;
          this.isRecording = true;
          this.playerRef.src = "";
          navigator.mediaDevices
            .getUserMedia(this.constraints)
            .then(this.handleSuccess.bind(this))
            .catch(this.handleError.bind(this));
          micContainer.toggleClass("active");
          $(".mic")
            .addClass("ri-voiceprint-line")
            .removeClass("ri-user-voice-fill")
            .removeClass("ri-mic-line");
          $("#voice-retake").html("Recording");
        }

        stopRecording() {
          const micContainer = $(".circle").first();
          micContainer.toggleClass("active");
          if (!this.isRecording) return;
          this.isRecording = false;
          this.recorderRef.pause();
          this.mediaRecorder.stop();
          $(".mic")
            .removeClass("ri-mic-line")
            .addClass("ri-user-voice-fill")
            .removeClass("ri-voiceprint-line");
          $("#voice-retake").html("Retry");
        }
      }

      window.voiceRecorder = new VoiceRecorder();
    </script>
  </body>
</html>
